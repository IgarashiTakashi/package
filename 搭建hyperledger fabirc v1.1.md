# 搭建hyperledger fabirc v1.1

> 网上大多数hyperledger fabric的教程都是基于0.6或者1.0等比较老的版本, 主要采用go语言开发chaincode, 采用java-sdk去调用链码.

> 从fabirc1.1开始,官方推荐使用nodejs去开发链码,node-sdk调用代码.

## 0.环境搭建准备工作

建议使用ubuntu服务器,这里我直接使用了阿里云的乞丐版服务器,配置如下:

[![image](https://camo.githubusercontent.com/39e5a12819390268346ee8eb3032e3fae802d4be/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f34323146383442354630304534443141414444304444413130394645444139442f313336)](https://camo.githubusercontent.com/39e5a12819390268346ee8eb3032e3fae802d4be/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f34323146383442354630304534443141414444304444413130394645444139442f313336)

操作系统为Ubuntu 14.04(64位)为保证后续步骤一致,请使用跟我相同的版本.

## 1. 远超登录终端准备

用putty或者xshell远超连接进去

[![image](https://camo.githubusercontent.com/3da8fa6254642d45ea6deb0b51b7e1c9b53b38c5/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f46333436383446323441313534314334394544414545384539384435443541392f313437)](https://camo.githubusercontent.com/3da8fa6254642d45ea6deb0b51b7e1c9b53b38c5/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f46333436383446323441313534314334394544414545384539384435443541392f313437)

## 2. 安装git

```
apt-get update
apt-get install git
```

[![image](https://camo.githubusercontent.com/b955f65688eff9f1c39a9ecc5dcc368132e5d422/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f42383134323146313245463734393835393031324134323645443439333733362f313539)](https://camo.githubusercontent.com/b955f65688eff9f1c39a9ecc5dcc368132e5d422/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f42383134323146313245463734393835393031324134323645443439333733362f313539)

## 3. 安装docker-ce

请不要直接apt安装旧版本的docker

[阿里云安装docker教程](https://yq.aliyun.com/articles/110806?spm=5176.8351553.0.0.5d4e1991URD8Ia)

```
# step 1: 安装必要的一些系统工具
sudo apt-get update
sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common
# step 2: 安装GPG证书
curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -
# Step 3: 写入软件源信息
sudo add-apt-repository "deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable"
# Step 4: 更新并安装 Docker-CE
sudo apt-get -y update
sudo apt-get -y install docker-ce
```

安装完毕后效果如下: 查看版本 [![image](https://camo.githubusercontent.com/b3c3fa7175f548be90827e8b6730b61725bfe6df/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f38423841413839444637343734353843424141363742334130393235434631392f313935)](https://camo.githubusercontent.com/b3c3fa7175f548be90827e8b6730b61725bfe6df/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f38423841413839444637343734353843424141363742334130393235434631392f313935)

## 4. 设置阿里云docker加速服务

从docker官方的镜像服务器里面下载image非常慢, 使用阿里云的好处是可以拥有阿里的镜像加速服务, 速度可以达到百兆级别. 如果不配置也没有问题~ 多等一段时间就行了.

[![image](https://camo.githubusercontent.com/7b7e86b1ed145cdbab3bd97655b3f3016af6f1d1/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f39343138414235463239433234413331393531353541393939343437314432412f313739)](https://camo.githubusercontent.com/7b7e86b1ed145cdbab3bd97655b3f3016af6f1d1/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f39343138414235463239433234413331393531353541393939343437314432412f313739)

ubuntu14.04系统采用不支持systemctl

```
#重启docker服务
service docker restart
```

## 5. 安装hyperledger的工具和docker镜像

点击官方[参考文档](http://hyperledger-fabric.readthedocs.io/en/release-1.1/samples.html#binaries)

- 注意: 按照官方文档执行, 需要全局翻墙才行

[![image](https://camo.githubusercontent.com/bd133c7420656bbc6fea046216462f449df27c0a/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f42423738334344443532423834324134413142444145313939323346424135452f323235)](https://camo.githubusercontent.com/bd133c7420656bbc6fea046216462f449df27c0a/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f42423738334344443532423834324134413142444145313939323346424135452f323235)

- 安装完检查目录结构和docker镜像:

[![image](https://camo.githubusercontent.com/cbc19306a3be442f8a35c07d34fb542cb8de0cd7/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f41433341383939374235314334433635414639453144344346374633464344312f323332)](https://camo.githubusercontent.com/cbc19306a3be442f8a35c07d34fb542cb8de0cd7/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f41433341383939374235314334433635414639453144344346374633464344312f323332)

## 6. 下载官方的示例代码 fabric sample

```
git clone https://github.com/hyperledger/fabric-samples.git
```

[![image](https://camo.githubusercontent.com/7b012db1892c629e5683814db7dd75dd10b54d15/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f44413433344631323531413334324639394531424143433234433230383532342f323430)](https://camo.githubusercontent.com/7b012db1892c629e5683814db7dd75dd10b54d15/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f44413433344631323531413334324639394531424143433234433230383532342f323430)

## 7. 切换到first-network目录

[![image](https://camo.githubusercontent.com/51d1a69092df44868d954ecff33e406cc2006ca2/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f30463044413937393534393034364634383841463931454441433444344342352f323437)](https://camo.githubusercontent.com/51d1a69092df44868d954ecff33e406cc2006ca2/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f30463044413937393534393034364634383841463931454441433444344342352f323437)

## 8. 启动fabric ledger的第一个网络

运行如下命令:

```
#1. 配置环境变量, fabirc的二进制工具
export PATH=/root/bin:$PATH
#2. 生成hyperledger fabric的各种区块链配置
./byfn.sh -m generate
#3. 安装docker-compose
curl -L https://github.com/docker/compose/releases/download/1.20.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
参考文档  https://github.com/docker/compose/releases
#4. 启动first-network
./byfn.sh -m up
```

## 9. 修复阿里云服务器网络错误的问题

(腾讯云不存在这个问题,自己装ubuntu也不存在这个问题)

[![image](https://camo.githubusercontent.com/e296bf2a38c2a22efc4882549cdbfdef160719e0/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f41333433333244383639434334373243393742303346454641434345434436362f323732)](https://camo.githubusercontent.com/e296bf2a38c2a22efc4882549cdbfdef160719e0/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f41333433333244383639434334373243393742303346454641434345434436362f323732)

> /etc/resolv.conf 注释掉 options timeout:2 attempts:3 rotate single-request-reopen 重新执行

```
./byfn.sh -m down
./byfn.sh -m up
```

就能够正常启动了.

## 10. 验证网络搭建

接下来你能看到,peer节点启动,通道建立, 加入通道, 设置锚节点,实例化链码,调用链码等一系列的操作.如果你看到下面的图,恭喜你! 你的网络搭建好了. [![image](https://camo.githubusercontent.com/43997332a4a37933a9596d565ffe93b74e1b2ea2/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f42444135453544413033443134454634393942314435383936423637334231392f323833)](https://camo.githubusercontent.com/43997332a4a37933a9596d565ffe93b74e1b2ea2/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f42444135453544413033443134454634393942314435383936423637334231392f323833)

> 看到上面的截图,说明你的开发环境已经准备好, 接下来我们就可以搭建自己的组织结构,编写nodejs的链码了.

## 11. 停止网络请使用命令

```
./byfn.sh -m down
```

## 12. 切换到basic-network目录

来到fabirc-sample目录的basic-network文件夹

## 13. 修改 basic-network的docker-compose.yml

[![image](https://camo.githubusercontent.com/1e39b2dbdede5cf986298a6a36f6a8ad38a6e8a8/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f31343438333139314544314334314137393931413632453935344245373942442f323938)](https://camo.githubusercontent.com/1e39b2dbdede5cf986298a6a36f6a8ad38a6e8a8/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f31343438333139314544314334314137393931413632453935344245373942442f323938)

> 说明: 启用开发者模式,这样加快调试部署,减少资源开销 开启7052端口, 开发模式下不使用tls会减少出错的概率,生产环境需要启用tls

## 14. 修改 脚本 `start.sh`

[![image](https://camo.githubusercontent.com/5f7e70b9825f9fed923f507ff37833499b11f26a/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f31303641353841303531463834364345414344453235453834433932433142322f333133)](https://camo.githubusercontent.com/5f7e70b9825f9fed923f507ff37833499b11f26a/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f31303641353841303531463834364345414344453235453834433932433142322f333133)增加cli节点, cli是方面我们执行控制指令的终端. 我们会使用他与各个peer节点进行交互. 后面这些手动的命令,会通过nodejs的api来调用

## 15. 启动脚本 'start.h'

[![image](https://camo.githubusercontent.com/354db7fd7a2fd4d0bee4fc1949108992869268e0/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f45414430463231464139333934443543423845363339343735384332424232362f333236)](https://camo.githubusercontent.com/354db7fd7a2fd4d0bee4fc1949108992869268e0/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f45414430463231464139333934443543423845363339343735384332424232362f333236)

> 可以看到启动了ca节点,peer节点,order节点,cli节点和couchdb,创建了channel,peer加入了channel

## 16. 查看状态

[![image](https://camo.githubusercontent.com/fac0f6c14f8611dd59677aad532dcafede90081b/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f46414638433341313044463134423437423841463735374136464245383938392f333337)](https://camo.githubusercontent.com/fac0f6c14f8611dd59677aad532dcafede90081b/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f46414638433341313044463134423437423841463735374136464245383938392f333337)

```
docker ps
#可以看到当前运行的docker容器, peer,order,couchdb,ca,cli节点
docker exec -it bash 
#进入cli容器
peer channel list
#查看当前peer加入的channel
```

## 17. chaincode编写需要使用nodejs

请安装>8.0版本的nodejs

官网连接 [点我直达](https://nodejs.org/en/download/package-manager/#debian-and-ubuntu-based-linux-distributions)

```
curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
sudo apt-get install -y nodejs
```

## 18.编写nodejs的chaincode

```
#1.创建mycc文件夹
mkdir mycc
#2. 初始化package.json文件
npm init 
#3. 修改package.json文件
npm install --save fabric-shim --registry=https://registry.npm.taobao.org
```

成功后 目录结构如下: 终于package.json文件 [![image](https://camo.githubusercontent.com/0ba84ae0b6f207aab320701947056cefb96ce6e5/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f39314134454444463831383134383833413945453735373241423933444336452f333734)](https://camo.githubusercontent.com/0ba84ae0b6f207aab320701947056cefb96ce6e5/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f39314134454444463831383134383833413945453735373241423933444336452f333734)

## 19. 编写nodejs链码

```
const shim = require('fabric-shim');
const Chaincode = class{
    //链码初始化操作
    async Init(stub){
        var ret = stub.getFunctionAndParameters();
        var args  = ret.params;
        var a = args[0];
        var aValue = args[1];
        var b = args[2];
        var bValue = args[3];
        await  stub.putState(a,Buffer.from(aValue));
        await  stub.putState(b,Buffer.from(bValue));
        return shim.success(Buffer.from('heima chaincodinit successs'));
    }
    
    async Invoke(stub){
        let ret = stub.getFunctionAndParameters();
        let fcn = this[ret.fcn];
        return fcn(stub,ret.params);
    }
    //查询操作
    async query(stub,args){
        let a = args[0];
        let balance = await stub.getState(a);
        return shim.success(balance);
    }

};
shim.start(new Chaincode());
```

## 20. 把chaincode注册给peer

他们之间通过grcp协议通信

```
CORE_CHAINCODE_ID_NAME="mycc:v0"  npm start -- --peer.address grpc://192.168.0.1:7052
```

[![image](https://camo.githubusercontent.com/fc002895566d234585bd8e7cd9ac62ad843d3102/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f39344243423933433241324334313837383635383134433038343443313541442f333930)](https://camo.githubusercontent.com/fc002895566d234585bd8e7cd9ac62ad843d3102/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f39344243423933433241324334313837383635383134433038343443313541442f333930)

## 21. 在peer上install安装链码

这是peer上chaincode的生命周期

```
CORE_PEER_LOCALMSPID=Org1MSP CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp peer chaincode install -l node -n mycc -v v0 -p /opt/gopath/src/github.com/mycc/
```

[![image](https://camo.githubusercontent.com/2e7c39a81ad135f660b7771ba945831602afcc0e/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f35424230363342413745343434394632424345333735324634344632464138362f343036)](https://camo.githubusercontent.com/2e7c39a81ad135f660b7771ba945831602afcc0e/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f35424230363342413745343434394632424345333735324634344632464138362f343036)

## 22. 在peer上实例化链码

```
CORE_PEER_LOCALMSPID=Org1MSP CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp peer chaincode instantiate -l node -n mycc -v v0 -C mychannel -c '{"args":["init","zzh","100","czbk","100"]}' -o 192.168.0.1:7050
```

[![image](https://camo.githubusercontent.com/8326ec5f8c0653a0b106f61170134003a93739f0/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f34314244374643323746363634423644393732453743364246303438303432462f343133)](https://camo.githubusercontent.com/8326ec5f8c0653a0b106f61170134003a93739f0/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f34314244374643323746363634423644393732453743364246303438303432462f343133)

## 23. 测试链码调用

```
CORE_PEER_LOCALMSPID=Org1MSP CORE_PEER_MSPCONFIGPATH=/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/org1.example.com/users/Admin@org1.example.com/msp peer chaincode invoke -n mycc -C mychannel -c '{"args":["query","zzh"]}' -o 192.168.0.1:7050
```

[![image](https://camo.githubusercontent.com/da2011720a7c11d5ba476205cddf8b470a6ff822/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f36453141423145363135363734423230414636303235434234303532364431352f343232)](https://camo.githubusercontent.com/da2011720a7c11d5ba476205cddf8b470a6ff822/68747470733a2f2f6e6f74652e796f7564616f2e636f6d2f7977732f7075626c69632f7265736f757263652f39356330383764623963326634323439363136613430353863353231636131332f786d6c6e6f74652f36453141423145363135363734423230414636303235434234303532364431352f343232)

可以查看到zzh账户上有100块钱.

## 24. 同理大家可以实现转账的操作.

试着自己实现一下transfer方法吧

## 25. 停止网络使用

```
./stop.sh ./teardown.sh
```

## 26. 查看环境是否清理干净

```
docker ps
```

> 无内容就说明环境清理干净

## 开发环境快速搭建

1. docker
2. docker-compose
3. git
4. nodejs

```
#安装docker
curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
#安装docker-compose
curl -L https://github.com/docker/compose/releases/download/1.20.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
#安装git
apt-get update
apt-get install git
#安装nodejs
curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -
sudo apt-get install -y nodejs
```

> 修复阿里云超时bug
> /etc/resolv.conf 注释掉 options timeout:2 attempts:3 rotate single-request-reopen 

> 下载二进制脚本和安装docker镜像
> curl -sSL https://raw.githubusercontent.com/itheima1/BlockChain/master/tools/bootstrap.sh | bash -s 1.1.0